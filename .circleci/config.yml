version: 2.1

orbs:
  android: circleci/android@2.3.0
  node: circleci/node@5.1.0

jobs:
  build-android:
    executor:
      name: android/android-docker
      tag: 2024.01.1
    steps:
      - checkout
      
      - node/install:
          node-version: '20'
      
      - run:
          name: Install dependencies
          command: npm ci
      
      - run:
          name: Clear cache
          command: |
            rm -rf node_modules/.cache
            rm -rf .expo
      
      - run:
          name: Install Expo CLI
          command: npm install -g expo-cli eas-cli
      
      - run:
          name: Prebuild Android
          command: npx expo prebuild --platform android --clean
      
      - run:
          name: Build APK (ARM64-v8a)
          command: |
            cd android
            ./gradlew assembleRelease -PreactNativeArchitectures=arm64-v8a
      
      - store_artifacts:
          path: android/app/build/outputs/apk/release/app-release.apk
          destination: AquaIntel-ARM64.apk

workflows:
  build-and-test:
    jobs:
      - build-android:
          filters:
            branches:
              only:
                - main
                - develop
